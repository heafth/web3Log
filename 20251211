📝 Go 语言垃圾回收（GC）知识笔记
1️⃣ GC 基本概念

目标：自动回收不可达（无引用）对象，释放内存，尽量减少对程序的停顿

算法：Go 使用 三色标记法（tri-color marking） + 并发清扫

特点：

并发标记阶段与程序同时运行

只有极短暂停（STW，stop-the-world）

使用写屏障保证标记完整性

2️⃣ Go GC 的四个阶段
阶段	核心动作	是否暂停程序
1. 标记开始（STW）	初始化 GC，扫描 root，开启写屏障	✅ 短暂停
2. 并发标记（Concurrent Mark）	遍历对象图，标记可达对象（黑色/灰色/白色）	❌ 程序并发运行
3. 标记终止（STW）	收尾，处理灰对象队列，关闭写屏障	✅ 短暂停
4. 并发清扫（Concurrent Sweep）	回收不可达对象，释放内存，按需清扫	❌ 并发运行

备注：

STW 阶段非常短，保证程序几乎不中断

并发清扫不会一次清完，而是按 span 逐步释放

3️⃣ 三色标记法 + 写屏障
三色对象状态
颜色	含义
白色	未访问 → 可回收对象
灰色	被发现但子对象未完全扫描
黑色	已标记完成，不回收
写屏障（Write Barrier）

概念：在程序写入指针时自动触发的附加逻辑（钩子）

作用：

保证并发标记阶段不会遗漏新创建或新引用的对象

将新引用对象染灰，加入灰队列，确保 GC 后续标记

例子：

// 写屏障触发
parent.child = newObj
// oldObj 如果没有其他引用 → 可回收
// newObj 写屏障染灰 → 黑色 → 不回收

4️⃣ 回收规则

可达对象：从 root 或其他黑色对象可访问 → 标记为黑色 → 不回收

不可达对象：白色 → 清扫阶段回收

程序修改引用时：

写屏障保证新对象不会漏标

旧对象如果无其他引用 → 成为白色 → 回收

5️⃣ STW（Stop-the-world）总结

次数：两次短暂停

GC 开始阶段

标记终止阶段

作用：

切换 GC 状态

扫描 root

完成标记收尾

6️⃣ 关键示例理解
oldObj := &Object{}
newObj := &Object{}
parent := &Object{child: oldObj}

parent.child = newObj // 触发写屏障


oldObj：如果无其他引用 → 可回收

newObj：写屏障染灰 → GC 后变黑 → 不回收

parent：root 对象 → 不回收

理解关键：写屏障保证并发标记阶段不会漏掉 newObj，新对象不会被误删。

7️⃣ 核心总结

Go GC 并发标记 + 并发清扫，减少 STW 停顿

STW 只有两次，非常短，保证标记完整

三色标记 + 写屏障保证可达对象不会被误删

不可达对象按需回收，lazy sweep

写屏障 = 在写指针时自动执行逻辑，保持 GC 正确性
